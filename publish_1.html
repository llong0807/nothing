<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑地址与货物 - 高级交互版</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Inter 字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 自定义基础样式 */
        body {
            font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            color: #333;
            box-sizing: border-box;
        }

        /* 模拟移动设备屏幕容器 */
        .mobile-container {
            width: 100%;
            height: 100vh;
            background-color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 所有可切换页面的基础样式 */
        .page {
            transition: transform 0.3s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            z-index: 1;
        }
        .page.hidden {
            transform: translateX(100%);
        }
        .page.active {
            z-index: 2;
            transform: translateX(0);
        }

        /* 头部样式 */
        .header {
            padding: 15px 20px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            background-color: #fff;
            color: #333;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .header .back-arrow {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            padding: 5px;
        }
        .header .header-title {
            flex-grow: 1;
            text-align: center;
            margin-right: 34px;
        }

        /* 地址簿卡片样式 */
        .address-card {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            position: relative;
        }
        .address-card:hover {
            transform: translateY(-2px);
        }
        .address-card .delete-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: #fce7e7;
            color: #ef4444;
            border-radius: 9999px;
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            outline: none;
        }

        /* Custom extra-extra-small text size for location button */
        .text-xxs {
            font-size: 0.6rem;
            line-height: 1rem;
        }

        /* Input-like button style from publish_2 */
        .input-like-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #999; /* Hint text color */
            background-color: #f9f9f9;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .input-like-button:hover {
            background-color: #f0f0f0;
            border-color: #ccc;
        }


        /* Time selection button active state */
        .time-option-btn.active {
            background-color: #e0f2fe;
            color: #2563eb;
            border-color: #2563eb;
        }

        /* Time selection modal specific styles */
        .time-modal-content {
            height: 300px;
        }
        .time-list-item {
            padding: 10px 0;
            text-align: center;
            cursor: pointer;
        }
        .time-list-item.selected {
            background-color: #e0f2fe;
            color: #2563eb;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="mobile-container">

    <!-- =================================================================== -->
    <!-- Page 1: 编辑地址 (主页) -->
    <!-- =================================================================== -->
    <div id="main-page" class="page active">
        <!-- 头部 -->
        <header class="header">
            <button class="back-arrow p-2" onclick="window.parent.postMessage({ action: 'closePublishFlow' }, '*')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-800"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <h1 class="header-title">发布货源</h1>
            <span></span>
        </header>

        <!-- 主要内容区域 -->
        <main class="flex-1 p-4 overflow-y-auto bg-[#FFF9F7]">
            <!-- 地址信息卡片 -->
            <div class="bg-white rounded-xl shadow-md p-5 mb-4">
                <!-- 装货地址 -->
                <div class="address-group" data-address-type="loading">
                    <div class="flex items-start">
                        <div class="w-12 h-12 rounded-lg bg-orange-100 flex items-center justify-center mr-4 flex-shrink-0">
                            <span class="text-orange-500 font-bold text-lg">装</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <div class="address-region-display text-gray-400 cursor-pointer py-1" data-target-id="loading-region">请选择省份/城市/区县</div>
                                <button class="open-address-book-btn text-blue-500 text-xs font-medium py-0.5 px-2 rounded-full border border-blue-500">地址簿</button>
                            </div>
                            <div class="border-t border-gray-100 my-2"></div>
                            <div class="flex items-center justify-between">
                                <div class="address-detail-display flex-grow text-gray-400 cursor-pointer py-1" data-target-id="loading-detail">详细地址（例如**街**号）</div>
                                <button class="open-map-location-btn flex flex-col items-center text-blue-500 text-xxs font-medium py-0 px-1 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin"><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"></path><path d="M12 22s-8-4-8-10a8 8 0 0 1 16 0c0 6-8 10-8 10z"></path></svg>
                                    <span class="whitespace-nowrap">定位</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 分割线 -->
                <div class="border-t border-gray-100 my-5"></div>
                <!-- 卸货地址 -->
                <div class="address-group" data-address-type="unloading">
                    <div class="flex items-start">
                        <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center mr-4 flex-shrink-0">
                            <span class="text-blue-500 font-bold text-lg">卸</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <div class="address-region-display text-gray-400 cursor-pointer py-1" data-target-id="unloading-region">请选择省份/城市/区县</div>
                                <button class="open-address-book-btn text-blue-500 text-xs font-medium py-0.5 px-2 rounded-full border border-blue-500">地址簿</button>
                            </div>
                            <div class="border-t border-gray-100 my-2"></div>
                            <div class="flex items-center justify-between">
                                <div class="address-detail-display flex-grow text-gray-400 cursor-pointer py-1" data-target-id="unloading-detail">详细地址（例如**街**号）</div>
                                <button class="open-map-location-btn flex flex-col items-center text-blue-500 text-xxs font-medium py-0 px-1 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin"><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"></path><path d="M12 22s-8-4-8-10a8 8 0 0 1 16 0c0 6-8 10-8 10z"></path></svg>
                                    <span class="whitespace-nowrap">定位</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- START: Migrated Cargo Card -->
            <div class="bg-white rounded-xl shadow-md p-4 mb-4">
                <h2 class="font-bold text-gray-800 text-base mb-4">货物信息</h2>

                <div id="quick-fill-cargo-btn" class="input-like-button mb-4">
                    <span id="cargo-info-display" class="text-gray-500">点击我编辑货物信息</span>
                </div>

                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <label for="cargo-length" class="text-sm font-medium text-gray-700 mr-1">长</label>
                        <input type="text" id="cargo-length" placeholder="0.00" class="w-14 p-1 border border-gray-300 rounded-md text-center text-sm">
                        <span class="ml-1 text-sm text-gray-500">米</span>
                    </div>
                    <div class="flex items-center">
                        <label for="cargo-width" class="text-sm font-medium text-gray-700 mr-1">宽</label>
                        <input type="text" id="cargo-width" placeholder="0.00" class="w-14 p-1 border border-gray-300 rounded-md text-center text-sm">
                        <span class="ml-1 text-sm text-gray-500">米</span>
                    </div>
                    <div class="flex items-center">
                        <label for="cargo-height" class="text-sm font-medium text-gray-700 mr-1">高</label>
                        <input type="text" id="cargo-height" placeholder="0.00" class="w-14 p-1 border border-gray-300 rounded-md text-center text-sm">
                        <span class="ml-1 text-sm text-gray-500">米</span>
                    </div>
                </div>

                <div class="flex items-center mb-2">
                    <label for="cargo-tonnage" class="w-16 text-sm font-medium text-gray-700 flex-shrink-0">重量</label>
                    <input type="text" id="cargo-tonnage" placeholder="0.00" class="flex-1 p-2 border border-gray-300 rounded-md">
                    <span class="ml-2 text-sm text-gray-500">吨</span>
                </div>

                <div class="flex items-center mb-0">
                    <label for="cargo-notes" class="w-16 text-sm font-medium text-gray-700 flex-shrink-0">备注</label>
                    <input type="text" id="cargo-notes" placeholder="选填" class="flex-1 p-2 border border-gray-300 rounded-md">
                </div>
            </div>
            <!-- END: Migrated Cargo Card -->

            <!-- 时间选择卡片 -->
            <div class="bg-white rounded-xl shadow-md p-5 mb-4">
                <div class="flex flex-col">
                    <p class="font-bold text-gray-800 text-base mb-2">期望装货时间</p>
                    <div class="flex justify-end items-center space-x-3">
                        <button class="select-time-btn time-option-btn bg-gray-100 text-gray-700 text-sm font-medium py-2.5 px-5 rounded-full border border-gray-300" data-time-type="loading">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar inline-block mr-1"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                            <span>选择时间</span>
                        </button>
                        <button class="anytime-btn time-option-btn bg-gray-100 text-gray-700 text-sm font-medium py-2.5 px-5 rounded-full border border-gray-300 active" data-time-type="loading">随到随装</button>
                    </div>
                </div>
                <div class="border-t border-gray-100 my-5"></div>
                <div class="flex flex-col">
                    <p class="font-bold text-gray-800 text-base mb-2">期望卸货时间</p>
                    <div class="flex justify-end items-center space-x-3">
                        <button class="select-time-btn time-option-btn bg-gray-100 text-gray-700 text-sm font-medium py-2.5 px-5 rounded-full border border-gray-300" data-time-type="unloading">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar inline-block mr-1"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                            <span>选择时间</span>
                        </button>
                        <button class="anytime-btn time-option-btn bg-gray-100 text-gray-700 text-sm font-medium py-2.5 px-5 rounded-full border border-gray-300 active" data-time-type="unloading">随到随卸</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- 底部按钮 -->
        <footer class="bg-white p-4 flex items-center space-x-4 border-t border-gray-200 mt-auto flex-shrink-0">
            <button id="temporary-leave-btn" class="flex-1 bg-orange-100 text-orange-500 font-bold py-3.5 rounded-full">暂时离开</button>
            <button id="next-step-btn" class="flex-1 bg-blue-500 text-white font-bold py-3.5 rounded-full">下一步</button>
        </footer>
    </div>

    <!-- =================================================================== -->
    <!-- Page 2: 编辑详细地址 -->
    <!-- =================================================================== -->
    <div id="edit-address-page" class="page hidden">
        <!-- 头部 -->
        <header class="header">
            <button id="back-to-main-from-address-btn" class="back-arrow p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-800"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <h1 class="header-title">编辑详细地址</h1>
            <span></span>
        </header>

        <!-- 文本编辑区域 -->
        <div class="p-4 flex-shrink-0">
            <div class="relative">
                <textarea id="address-textarea" maxlength="100" class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="详细地址（例如**街**号）"></textarea>
                <div id="address-editor-buttons" class="absolute bottom-3 right-3 flex items-center space-x-2">
                    <!-- 按钮将由JS动态插入 -->
                </div>
            </div>
        </div>

        <!-- 匹配地址区域 -->
        <div id="address-suggestions" class="flex-1 bg-gray-50 overflow-y-auto">
            <!-- 匹配的地址列表将由JS动态插入 -->
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- Page: 编辑货源 (Migrated) -->
    <!-- =================================================================== -->
    <div id="edit-cargo-page" class="page hidden">
        <!-- Header -->
        <header class="header">
            <button id="back-to-main-from-cargo-btn" class="back-arrow p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-800"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <h1 class="header-title">编辑货源</h1>
            <span></span>
        </header>

        <!-- Text editing area -->
        <div class="p-4 flex-shrink-0">
            <div class="relative">
                <textarea id="cargo-textarea" maxlength="100" class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="请输入货物名称或型号，例如：挖掘机、起重机"></textarea>
                <div id="cargo-editor-buttons" class="absolute bottom-3 right-3 flex items-center space-x-2">
                    <!-- Buttons will be dynamically inserted -->
                </div>
            </div>
        </div>

        <!-- Matching cargo information area -->
        <div id="cargo-suggestions" class="flex-1 bg-gray-50 overflow-y-auto">
            <!-- Matching cargo list will be dynamically inserted -->
        </div>
    </div>


    <!-- =================================================================== -->
    <!-- Page 3: 地址簿页面 -->
    <!-- =================================================================== -->
    <div id="address-book-page" class="page hidden">
        <!-- 头部 -->
        <header class="header">
            <button id="back-to-main-from-address-book-btn" class="back-arrow p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-800"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <h1 class="header-title">地址簿</h1>
            <span></span>
        </header>

        <!-- 地址列表区域 -->
        <div id="address-book-list" class="flex-1 p-4 overflow-y-auto bg-gray-100">
            <!-- 地址卡片将由JS动态插入 -->
        </div>

        <footer class="bg-white p-4 border-t border-gray-200 flex justify-center items-center flex-shrink-0">
        </footer>
    </div>

    <!-- =================================================================== -->
    <!-- Page 4: 地图定位页面 -->
    <!-- =================================================================== -->
    <div id="map-location-page" class="page hidden">
        <header class="header">
            <button id="back-to-previous-page-from-map-btn" class="back-arrow p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-800"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <h1 class="header-title">地图定位</h1>
            <span></span>
        </header>
        <div class="flex-1 flex items-center justify-center bg-blue-100 text-gray-500 text-lg">
            <p>这里是地图定位模拟区域</p>
            <button id="confirm-map-location-btn" class="absolute bottom-10 bg-blue-500 text-white font-bold py-3 px-6 rounded-full shadow-lg">
                确认定位
            </button>
        </div>
    </div>

</div>

<!-- =================================================================== -->
<!-- Modal: 省市区选择 -->
<!-- =================================================================== -->
<div id="region-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-end hidden" style="z-index: 100;">
    <div class="bg-white w-full max-w-[375px] rounded-t-2xl">
        <div class="p-4 flex justify-between items-center border-b">
            <h2 class="font-bold text-lg">选择地区</h2>
            <button id="close-modal-btn" class="text-gray-500">&times;</button>
        </div>
        <div class="flex p-2 border-b">
            <div id="province-tab" class="px-4 py-2 cursor-pointer font-semibold text-blue-600 border-b-2 border-blue-600">请选择</div>
            <div id="city-tab" class="px-4 py-2 cursor-pointer text-gray-500 hidden"></div>
            <div id="district-tab" class="px-4 py-2 cursor-pointer text-gray-500 hidden"></div>
        </div>
        <div id="region-lists" class="h-96 overflow-y-auto">
        </div>
    </div>
</div>

<!-- =================================================================== -->
<!-- Modal: 时间选择弹窗 -->
<!-- =================================================================== -->
<div id="time-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-end hidden" style="z-index: 100;">
    <div class="bg-white w-full max-w-[375px] rounded-t-2xl">
        <div class="p-4 flex justify-between items-center border-b">
            <h2 id="time-modal-title" class="font-bold text-lg text-left flex-grow">期望装货时间</h2>
            <button id="close-time-modal-btn" class="text-gray-500 text-2xl">&times;</button>
        </div>
        <div class="flex time-modal-content">
            <div id="month-list" class="flex-1 overflow-y-auto border-r border-gray-200"></div>
            <div id="day-list" class="flex-1 overflow-y-auto"></div>
        </div>
        <div class="p-4 border-t border-gray-200">
            <button id="confirm-time-selection-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-full">确定</button>
        </div>
    </div>
</div>

<!-- =================================================================== -->
<!-- Modal: 暂时离开确认对话框 (为开发人员提示) -->
<!-- =================================================================== -->
<div id="temporary-leave-confirm-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden" style="z-index: 101;">
    <div class="bg-white rounded-lg p-6 shadow-lg text-center w-80">
        <p class="text-lg font-semibold mb-4">需求注意</p>
        <p class="text-sm text-gray-700 mb-6">点击暂时离开按钮之后，页面上的数据要进行本地缓存，不仅缓存第一页，第二页也是如此。在下次进入页面后自动填入。</p>
        <div class="flex justify-center">
            <button id="confirm-dev-leave-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-full">确定</button>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 页面元素 ---
        const mainPage = document.getElementById('main-page');
        const editAddressPage = document.getElementById('edit-address-page');
        const editCargoPage = document.getElementById('edit-cargo-page'); // Migrated
        const addressBookPage = document.getElementById('address-book-page');
        const mapLocationPage = document.getElementById('map-location-page');

        const addressDetailDisplays = document.querySelectorAll('.address-detail-display');
        const openAddressBookBtns = document.querySelectorAll('.open-address-book-btn');
        const openMapLocationBtns = document.querySelectorAll('.open-map-location-btn');

        // --- 编辑详细地址页元素 ---
        const addressTextarea = document.getElementById('address-textarea');
        const addressEditorButtonsContainer = document.getElementById('address-editor-buttons');
        const addressSuggestionsContainer = document.getElementById('address-suggestions');

        // --- 编辑货源页元素 (Migrated) ---
        const quickFillCargoBtn = document.getElementById('quick-fill-cargo-btn');
        const cargoInfoDisplay = document.getElementById('cargo-info-display');
        const cargoLengthInput = document.getElementById('cargo-length');
        const cargoWidthInput = document.getElementById('cargo-width');
        const cargoHeightInput = document.getElementById('cargo-height');
        const cargoTonnageInput = document.getElementById('cargo-tonnage');
        const cargoNotesInput = document.getElementById('cargo-notes');
        const cargoTextarea = document.getElementById('cargo-textarea');
        const cargoEditorButtonsContainer = document.getElementById('cargo-editor-buttons');
        const cargoSuggestionsContainer = document.getElementById('cargo-suggestions');
        const backToMainFromCargoBtn = document.getElementById('back-to-main-from-cargo-btn');


        // --- 地址簿页元素 ---
        const addressBookList = document.getElementById('address-book-list');

        // --- 地图定位页元素 ---
        const confirmMapLocationBtn = document.getElementById('confirm-map-location-btn');

        // --- 地区选择弹窗元素 ---
        const regionModal = document.getElementById('region-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const addressRegionDisplays = document.querySelectorAll('.address-region-display');
        const regionListsContainer = document.getElementById('region-lists');
        const tabs = {
            province: document.getElementById('province-tab'),
            city: document.getElementById('city-tab'),
            district: document.getElementById('district-tab'),
        };

        // --- 时间选择相关元素 ---
        const selectTimeBtns = document.querySelectorAll('.select-time-btn');
        const anytimeBtns = document.querySelectorAll('.anytime-btn');
        const timeSelectionModal = document.getElementById('time-selection-modal');
        const closeTimeModalBtn = document.getElementById('close-time-modal-btn');
        const timeModalTitle = document.getElementById('time-modal-title');
        const monthList = document.getElementById('month-list');
        const dayList = document.getElementById('day-list');
        const confirmTimeSelectionBtn = document.getElementById('confirm-time-selection-btn');

        // --- 底部按钮 ---
        const temporaryLeaveBtn = document.getElementById('temporary-leave-btn');
        const nextStepBtn = document.getElementById('next-step-btn');

        // --- 暂时离开确认对话框元素 ---
        const temporaryLeaveConfirmDialog = document.getElementById('temporary-leave-confirm-dialog');
        const confirmDevLeaveBtn = document.getElementById('confirm-dev-leave-btn');


        // --- 导航按钮 ---
        const backToMainFromAddressBtn = document.getElementById('back-to-main-from-address-btn');
        const backToMainFromAddressBookBtn = document.getElementById('back-to-main-from-address-book-btn');
        const backToPreviousPageFromMapBtn = document.getElementById('back-to-previous-page-from-map-btn');


        // --- 状态变量 ---
        let currentEditingAddressType = null;
        let currentEditingTimeType = null;
        let currentEditingRegionTarget = null;
        let selectedRegion = { province: '', city: '', district: '' };
        let currentPageInIframe = mainPage;
        let previousPageFromMap = null;
        let selectedMonth = null;
        let selectedDay = null;
        let selectedCargo = null; // Migrated

        // --- 模拟数据 ---
        const mockAddressData = [
            { name: '天安门广场', detail: '北京市东城区东长安街' },
            { name: '东方明珠广播电视塔', detail: '上海市浦东新区世纪大道1号' },
            { name: '西湖', detail: '浙江省杭州市西湖区龙井路1号' },
            { name: '故宫博物院', detail: '北京市东城区景山前街4号' },
            { name: '外滩', 'detail': '上海市黄浦区中山东一路' },
            { name: '阿里巴巴西溪园区', detail: '浙江省杭州市余杭区文一西路969号' },
            { name: '哈哈大厦', detail: '北京市朝阳区哈哈路88号' }
        ];

        let mockAddressBookData = [
            { id: 'ab1', region: '北京市 北京市', detail: '东城区东长安街天安门广场' },
            { id: 'ab2', region: '上海市 上海市', detail: '浦东新区世纪大道1号东方明珠' },
            { id: 'ab3', region: '浙江省 杭州市', detail: '西湖区龙井路1号西湖' },
            { id: 'ab4', region: '北京市 北京市', detail: '朝阳区哈哈路88号哈哈大厦' },
            { id: 'ab5', region: '广东省 深圳市', detail: '南山区科技园深南大道1000号' },
            { id: 'ab6', region: '四川省 成都市', detail: '武侯区天府大道北段2000号' }
        ];

        const mockRegionData = {
            "北京市": { "北京市": ["东城区", "西城区", "朝阳区", "海淀区"] },
            "上海市": { "上海市": ["黄浦区", "徐汇区", "长宁区", "静安区", "浦东新区"] },
            "浙江省": { "杭州市": ["上城区", "拱墅区", "西湖区", "余杭区"], "宁波市": ["海曙区", "江北区", "镇海区"] },
            "广东省": { "深圳市": ["福田区", "罗湖区", "南山区", "宝安区"] },
            "四川省": { "成都市": ["锦江区", "青羊区", "金牛区", "武侯区"] }
        };

        const mockCargoData = [ // Migrated
            { name: '挖掘机', detail: '卡特彼勒 320D', length: 9.5, width: 2.9, height: 3.1, tonnage: 22, notes: '工作状态良好' },
            { name: '挖掘机', detail: '小松 PC200-8', length: 9.4, width: 2.8, height: 3.0, tonnage: 20, notes: '近期保养' },
            { name: '起重机', detail: '徐工 QY25K', length: 12.8, width: 2.5, height: 3.4, tonnage: 25, notes: '带吊具' },
            { name: '起重机', detail: '中联重科 ZMC25', length: 13.0, width: 2.6, height: 3.5, tonnage: 28, notes: '需专业操作' },
            { name: '推土机', detail: '山推 SD16', length: 5.1, width: 3.4, height: 3.0, tonnage: 17, notes: '履带式' },
            { name: '装载机', detail: '柳工 CLG856', length: 8.1, width: 3.0, height: 3.5, tonnage: 18, notes: '轮式，带铲斗' },
            { name: '压路机', detail: '三一 SSR200C-8', length: 6.0, width: 2.3, height: 3.0, tonnage: 12, notes: '振动压实' }
        ];

        // =================================================
        // 页面切换逻辑
        // =================================================
        function showPageInIframe(targetPage) {
            console.log(`iframe内部切换页面：从 ${currentPageInIframe.id} 到 ${targetPage.id}`);
            if (currentPageInIframe) {
                currentPageInIframe.classList.remove('active');
                currentPageInIframe.classList.add('hidden');
            }
            targetPage.classList.remove('hidden');
            targetPage.classList.add('active');
            currentPageInIframe = targetPage;
            console.log(`iframe内部当前页面已更新为：${currentPageInIframe.id}`);
        }

        // 从主页进入编辑详细地址页
        addressDetailDisplays.forEach(el => {
            el.addEventListener('click', () => {
                currentEditingAddressType = el.closest('.address-group').dataset.addressType;
                showPageInIframe(editAddressPage);
                addressTextarea.value = '';
                addressTextarea.dispatchEvent(new Event('input'));
                addressSuggestionsContainer.innerHTML = '';
            });
        });

        // 从编辑详细地址页返回主页
        backToMainFromAddressBtn.addEventListener('click', () => {
            showPageInIframe(mainPage);
        });

        // 从主页进入地址簿页
        openAddressBookBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentEditingAddressType = btn.closest('.address-group').dataset.addressType;
                renderAddressBook();
                showPageInIframe(addressBookPage);
            });
        });

        // 从主页进入地图定位页
        openMapLocationBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentEditingAddressType = btn.closest('.address-group').dataset.addressType;
                previousPageFromMap = mainPage;
                showPageInIframe(mapLocationPage);
            });
        });

        // 从地址簿页返回主页
        backToMainFromAddressBookBtn.addEventListener('click', () => {
            showPageInIframe(mainPage);
        });

        // 从地图定位页返回上一页
        backToPreviousPageFromMapBtn.addEventListener('click', () => {
            if (previousPageFromMap) {
                showPageInIframe(previousPageFromMap);
            } else {
                showPageInIframe(mainPage);
            }
        });

        // "快速填写货物信息" 按钮的事件监听器 (Migrated)
        quickFillCargoBtn.addEventListener('click', () => {
            showPageInIframe(editCargoPage);
            cargoTextarea.value = ''; // 清空之前的内容
            cargoTextarea.dispatchEvent(new Event('input')); // 触发 input 事件以更新按钮
            cargoSuggestionsContainer.innerHTML = ''; // 清空建议
        });

        // 从编辑货源页返回 (Migrated)
        backToMainFromCargoBtn.addEventListener('click', () => {
            showPageInIframe(mainPage);
        });


        // 模拟地图定位确认，并回填数据到主页
        confirmMapLocationBtn.addEventListener('click', () => {
            const simulatedMapAddress = {
                region: "上海市 浦东新区",
                detail: "世纪大道100号 (模拟地图定位)"
            };

            if (currentEditingAddressType) {
                const regionDisplay = document.querySelector(`.address-region-display[data-target-id="${currentEditingAddressType}-region"]`);
                const detailDisplay = document.querySelector(`.address-detail-display[data-target-id="${currentEditingAddressType}-detail"]`);

                if (regionDisplay) {
                    regionDisplay.textContent = simulatedMapAddress.region;
                    regionDisplay.classList.remove('text-gray-400');
                    regionDisplay.classList.add('text-gray-800', 'font-bold');
                }
                if (detailDisplay) {
                    detailDisplay.textContent = simulatedMapAddress.detail;
                    detailDisplay.classList.remove('text-gray-400');
                    detailDisplay.classList.add('text-gray-800', 'font-semibold');
                }
            }
            showPageInIframe(mainPage);
        });


        // =================================================
        // 编辑详细地址页面逻辑
        // =================================================
        addressTextarea.addEventListener('input', () => {
            const text = addressTextarea.value.trim();
            updateAddressEditorButtons(text);
            if (text.length >= 2) {
                renderAddressSuggestions(text);
            } else {
                addressSuggestionsContainer.innerHTML = '';
            }
        });

        function updateAddressEditorButtons(text) {
            addressEditorButtonsContainer.innerHTML = '';
            if (text.length > 0) {
                const clearBtn = document.createElement('button');
                clearBtn.textContent = '清空';
                clearBtn.className = 'py-1 px-3 border border-gray-400 text-gray-600 rounded-full text-sm';
                clearBtn.onclick = () => {
                    addressTextarea.value = '';
                    addressTextarea.focus();
                    addressTextarea.dispatchEvent(new Event('input'));
                };

                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = '确认';
                confirmBtn.className = 'py-1 px-3 bg-blue-500 text-white rounded-full text-sm';
                confirmBtn.onclick = confirmAddress;

                addressEditorButtonsContainer.append(clearBtn, confirmBtn);
            } else {
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '取消';
                cancelBtn.className = 'py-1 px-3 bg-gray-200 text-gray-700 rounded-full text-sm';
                cancelBtn.onclick = () => showPageInIframe(mainPage);
                addressEditorButtonsContainer.appendChild(cancelBtn);
            }
        }

        function confirmAddress() {
            const detailText = addressTextarea.value.trim();
            if (detailText) {
                const targetDisplay = document.querySelector(`.address-detail-display[data-target-id="${currentEditingAddressType}-detail"]`);
                targetDisplay.textContent = detailText;
                targetDisplay.classList.remove('text-gray-400');
                targetDisplay.classList.add('text-gray-800', 'font-semibold');
            }
            showPageInIframe(mainPage);
        }

        function highlightText(text, query) {
            if (!query) return text;
            const regex = new RegExp(query, 'gi');
            return text.replace(regex, match => `<span class="text-blue-500 font-bold">${match}</span>`);
        }

        function renderAddressSuggestions(query) {
            const filtered = mockAddressData.filter(addr =>
                addr.name.includes(query) || addr.detail.includes(query)
            );

            addressSuggestionsContainer.innerHTML = filtered.map(addr => {
                const highlightedName = highlightText(addr.name, query);
                const highlightedDetail = highlightText(addr.detail, query);
                return `
                    <div class="suggestion-item p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-100">
                        <p class="font-semibold text-gray-800">${highlightedName}</p>
                        <p class="text-sm text-gray-500 mt-1">${highlightedDetail}</p>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.suggestion-item').forEach((item, index) => {
                item.addEventListener('click', () => {
                    const selectedAddr = filtered[index];
                    addressTextarea.value = `${selectedAddr.name} ${selectedAddr.detail}`;
                    addressTextarea.dispatchEvent(new Event('input'));
                    addressSuggestionsContainer.innerHTML = '';
                });
            });
        }

        // =================================================
        // 编辑货源页逻辑 (Migrated)
        // =================================================

        // 更新编辑器按钮状态
        function updateCargoEditorButtons(text) {
            cargoEditorButtonsContainer.innerHTML = '';
            if (text.length > 0) {
                const clearBtn = document.createElement('button');
                clearBtn.textContent = '清空';
                clearBtn.className = 'py-1 px-3 border border-gray-400 text-gray-600 rounded-full text-sm';
                clearBtn.onclick = () => {
                    cargoTextarea.value = '';
                    cargoTextarea.focus();
                    cargoTextarea.dispatchEvent(new Event('input'));
                    selectedCargo = null;
                };

                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = '确认';
                confirmBtn.className = 'py-1 px-3 bg-blue-500 text-white rounded-full text-sm';
                confirmBtn.onclick = confirmCargo;

                cargoEditorButtonsContainer.append(clearBtn, confirmBtn);
            } else {
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '取消';
                cancelBtn.className = 'py-1 px-3 bg-gray-200 text-gray-700 rounded-full text-sm';
                cancelBtn.onclick = () => showPageInIframe(mainPage);
                cargoEditorButtonsContainer.appendChild(cancelBtn);
            }
        }

        // 确认货物选择并返回
        function confirmCargo() {
            let cargoToSave = null;
            if (selectedCargo) {
                cargoToSave = selectedCargo;
            } else {
                const customCargoName = cargoTextarea.value.trim();
                if (customCargoName) {
                    cargoToSave = {
                        name: customCargoName,
                        detail: customCargoName,
                        length: '', width: '', height: '', tonnage: '', notes: ''
                    };
                }
            }

            if (cargoToSave) {
                localStorage.setItem('selected_cargo_data', JSON.stringify(cargoToSave));
            }

            showPageInIframe(mainPage);
            loadCargoDataFromStorage();
        }

        // 渲染货物建议
        function renderCargoSuggestions(query) {
            const filtered = mockCargoData.filter(cargo =>
                cargo.name.includes(query) || cargo.detail.includes(query)
            );

            cargoSuggestionsContainer.innerHTML = filtered.map((cargo, index) => {
                const highlightedName = highlightText(cargo.name, query);
                const highlightedDetail = highlightText(cargo.detail, query);
                return `
                    <div class="cargo-suggestion-item p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-100" data-index="${index}">
                        <p class="font-semibold text-gray-800">${highlightedName}</p>
                        <p class="text-sm text-gray-500 mt-1">${highlightedDetail} (长: ${cargo.length}m 宽: ${cargo.width}m 高: ${cargo.height}m 吨位: ${cargo.tonnage}吨)</p>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.cargo-suggestion-item').forEach(item => {
                item.addEventListener('click', (event) => {
                    const index = parseInt(event.currentTarget.dataset.index);
                    selectedCargo = filtered[index];
                    cargoTextarea.value = `${selectedCargo.name} ${selectedCargo.detail}`;
                    cargoTextarea.dispatchEvent(new Event('input'));
                    cargoSuggestionsContainer.innerHTML = '';
                });
            });
        }

        // 从 localStorage 加载货物数据
        function loadCargoDataFromStorage() {
            const savedCargo = localStorage.getItem('selected_cargo_data');
            if (savedCargo) {
                const cargo = JSON.parse(savedCargo);
                cargoLengthInput.value = cargo.length || '';
                cargoWidthInput.value = cargo.width || '';
                cargoHeightInput.value = cargo.height || '';
                cargoTonnageInput.value = cargo.tonnage || '';
                cargoNotesInput.value = cargo.notes || '';

                cargoInfoDisplay.textContent = `${cargo.name || '未知'} ${cargo.detail || ''}`;
                cargoInfoDisplay.classList.remove('text-gray-500');
                cargoInfoDisplay.classList.add('text-gray-800', 'font-semibold');
                localStorage.removeItem('selected_cargo_data');
            } else {
                cargoInfoDisplay.textContent = '点击我编辑货物信息';
                cargoInfoDisplay.classList.add('text-gray-500');
                cargoInfoDisplay.classList.remove('text-gray-800', 'font-semibold');
            }
        }

        // 货物文本区域输入事件
        cargoTextarea.addEventListener('input', () => {
            const text = cargoTextarea.value.trim();
            updateCargoEditorButtons(text);
            if (text.length >= 1) {
                renderCargoSuggestions(text);
            } else {
                cargoSuggestionsContainer.innerHTML = '';
                selectedCargo = null;
            }
        });

        // =================================================
        // 输入格式化和验证逻辑 (Migrated)
        // =================================================
        function formatDecimalInput(inputElement, integerLimit, decimalLimit) {
            inputElement.addEventListener('input', (event) => {
                let value = event.target.value;
                value = value.replace(/[^0-9.]/g, '');

                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }

                if (parts[0] && parts[0].length > integerLimit) {
                    parts[0] = parts[0].substring(0, integerLimit);
                    value = parts.join('.');
                }

                if (parts[1] && parts[1].length > decimalLimit) {
                    parts[1] = parts[1].substring(0, decimalLimit);
                    value = parts.join('.');
                }

                event.target.value = value;
            });
        }

        // 对相关输入框应用格式化
        formatDecimalInput(cargoLengthInput, 3, 2);
        formatDecimalInput(cargoWidthInput, 3, 2);
        formatDecimalInput(cargoHeightInput, 3, 2);
        formatDecimalInput(cargoTonnageInput, 3, 2);

        // =================================================
        // 地址簿页面逻辑
        // =================================================
        function renderAddressBook() {
            addressBookList.innerHTML = '';
            if (mockAddressBookData.length === 0) {
                addressBookList.innerHTML = '<p class="text-center text-gray-500 mt-8">地址簿为空</p>';
                return;
            }

            mockAddressBookData.forEach(addr => {
                const card = document.createElement('div');
                card.className = 'address-card';
                card.dataset.id = addr.id;
                card.innerHTML = `
                    <p class="font-semibold text-gray-800">${addr.region}</p>
                    <p class="text-sm text-gray-600 mt-1">${addr.detail}</p>
                    <button class="delete-btn" data-id="${addr.id}">删除</button>
                `;
                addressBookList.appendChild(card);
            });

            document.querySelectorAll('.address-card').forEach(card => {
                card.addEventListener('click', (event) => {
                    if (event.target.classList.contains('delete-btn')) {
                        return;
                    }
                    const idToSelect = card.dataset.id;
                    const selectedAddr = mockAddressBookData.find(addr => addr.id === idToSelect);
                    if (selectedAddr && currentEditingAddressType) {
                        const regionDisplay = document.querySelector(`.address-region-display[data-target-id="${currentEditingAddressType}-region"]`);
                        const detailDisplay = document.querySelector(`.address-detail-display[data-target-id="${currentEditingAddressType}-detail"]`);

                        if (regionDisplay) {
                            regionDisplay.textContent = selectedAddr.region;
                            regionDisplay.classList.remove('text-gray-400');
                            regionDisplay.classList.add('text-gray-800', 'font-bold');
                        }
                        if (detailDisplay) {
                            detailDisplay.textContent = selectedAddr.detail;
                            detailDisplay.classList.remove('text-gray-400');
                            detailDisplay.classList.add('text-gray-800', 'font-semibold');
                        }
                    }
                    showPageInIframe(mainPage);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const idToDelete = event.target.dataset.id;
                    deleteAddress(idToDelete);
                });
            });
        }

        function deleteAddress(id) {
            mockAddressBookData = mockAddressBookData.filter(addr => addr.id !== id);
            renderAddressBook();
        }

        // =================================================
        // 地区选择弹窗逻辑
        // =================================================
        addressRegionDisplays.forEach(el => {
            el.addEventListener('click', () => {
                currentEditingRegionTarget = el;
                resetAndShowModal();
            });
        });

        closeModalBtn.addEventListener('click', () => regionModal.classList.add('hidden'));

        function resetAndShowModal() {
            selectedRegion = { province: '', city: '', district: '' };
            updateTabs('province');
            renderList(Object.keys(mockRegionData), 'province');
            regionModal.classList.remove('hidden');
        }

        function renderList(items, level) {
            regionListsContainer.innerHTML = items.map(item =>
                `<div class="region-item p-3 cursor-pointer hover:bg-gray-100" data-level="${level}" data-value="${item}">${item}</div>`
            ).join('');

            document.querySelectorAll('.region-item').forEach(item => {
                item.addEventListener('click', handleRegionSelection);
            });
        }

        function handleRegionSelection(event) {
            const { level, value } = event.target.dataset;
            selectedRegion[level] = value;

            if (level === 'province') {
                const cities = Object.keys(mockRegionData[value]);
                updateTabs('city', value);
                renderList(cities, 'city');
            } else if (level === 'city') {
                const districts = mockRegionData[selectedRegion.province][value];
                updateTabs('district', value);
                renderList(districts, 'district');
            } else if (level === 'district') {
                const fullRegion = `${selectedRegion.province} ${selectedRegion.city} ${selectedRegion.district}`;
                currentEditingRegionTarget.textContent = fullRegion;
                currentEditingRegionTarget.classList.remove('text-gray-400');
                currentEditingRegionTarget.classList.add('text-gray-800', 'font-bold');
                regionModal.classList.add('hidden');
            }
        }

        function updateTabs(activeLevel, value) {
            Object.values(tabs).forEach(tab => {
                tab.className = 'px-4 py-2 cursor-pointer text-gray-500';
                if(activeLevel !== 'province') tab.classList.remove('hidden');
            });

            if (activeLevel === 'province') {
                tabs.province.textContent = '请选择';
                tabs.city.classList.add('hidden');
                tabs.district.classList.add('hidden');
            } else if (activeLevel === 'city') {
                tabs.province.textContent = selectedRegion.province;
                tabs.city.textContent = '请选择';
                tabs.district.classList.add('hidden');
            } else if (activeLevel === 'district') {
                tabs.city.textContent = selectedRegion.city;
                tabs.district.textContent = '请选择';
            }

            tabs[activeLevel].className = 'px-4 py-2 cursor-pointer font-semibold text-blue-600 border-b-2 border-blue-600';
        }

        // =================================================
        // 时间选择弹窗逻辑
        // =================================================

        anytimeBtns.forEach(btn => {
            btn.classList.add('active');
            const selectBtn = btn.previousElementSibling;
            if (selectBtn && selectBtn.classList.contains('select-time-btn')) {
                selectBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar inline-block mr-1"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>选择时间</span>`;
                selectBtn.classList.remove('active');
            }
        });


        selectTimeBtns.forEach(btn => {
            btn.addEventListener('click', (event) => {
                currentEditingTimeType = event.currentTarget.dataset.timeType;
                const titleText = currentEditingTimeType === 'loading' ? '期望装货时间' : '期望卸货时间';
                timeModalTitle.textContent = titleText;
                timeSelectionModal.classList.remove('hidden');
                initializeTimePicker();
            });
        });

        anytimeBtns.forEach(btn => {
            btn.addEventListener('click', (event) => {
                const type = event.currentTarget.dataset.timeType;
                document.querySelectorAll(`.time-option-btn[data-time-type="${type}"]`).forEach(b => {
                    b.classList.remove('active', 'border-blue-600', 'bg-blue-100', 'text-blue-600');
                    b.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-300');
                });
                event.currentTarget.classList.add('active');
                event.currentTarget.classList.remove('bg-gray-100', 'text-gray-700', 'border-gray-300');
                event.currentTarget.classList.add('bg-blue-100', 'text-blue-600', 'border-blue-600');

                const selectBtn = document.querySelector(`.select-time-btn[data-time-type="${type}"]`);
                if (selectBtn) {
                    selectBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar inline-block mr-1"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>选择时间</span>`;
                    selectBtn.classList.remove('active', 'border-blue-600', 'bg-blue-100', 'text-blue-600');
                    selectBtn.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-300');
                }
            });
        });

        closeTimeModalBtn.addEventListener('click', () => {
            timeSelectionModal.classList.add('hidden');
        });

        confirmTimeSelectionBtn.addEventListener('click', () => {
            if (selectedMonth !== null && selectedDay !== null) {
                const date = new Date();
                date.setMonth(selectedMonth);
                date.setDate(selectedDay);

                const monthText = date.getMonth() + 1;
                const dayText = date.getDate();
                const formattedDate = `${monthText}月${dayText}日前`;

                const targetBtn = document.querySelector(`.select-time-btn[data-time-type="${currentEditingTimeType}"]`);
                if (targetBtn) {
                    targetBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar inline-block mr-1"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>${formattedDate}</span>`;
                    targetBtn.classList.add('active', 'bg-blue-100', 'text-blue-600');
                    targetBtn.classList.remove('bg-gray-100', 'text-gray-700');

                    const anytimeBtn = document.querySelector(`.anytime-btn[data-time-type="${currentEditingTimeType}"]`);
                    if (anytimeBtn) {
                        anytimeBtn.classList.remove('active', 'bg-blue-100', 'text-blue-600');
                        anytimeBtn.classList.add('bg-gray-100', 'text-gray-700');
                    }
                }
            }
            timeSelectionModal.classList.add('hidden');
        });

        function initializeTimePicker() {
            const today = new Date();
            selectedMonth = today.getMonth();
            selectedDay = today.getDate();

            renderMonths(today.getFullYear(), selectedMonth);
            renderDays(today.getFullYear(), selectedMonth, selectedDay);
        }

        function renderMonths(year, currentMonthIndex) {
            monthList.innerHTML = '';
            const today = new Date();
            const startMonth = today.getMonth();
            const startYear = today.getFullYear();

            for (let i = 0; i < 12; i++) {
                const monthDate = new Date(startYear, startMonth + i, 1);
                const monthNum = monthDate.getMonth();
                const yearNum = monthDate.getFullYear();

                const monthItem = document.createElement('div');
                monthItem.classList.add('time-list-item', 'py-2', 'cursor-pointer', 'hover:bg-gray-100');
                monthItem.textContent = `${yearNum}年${monthNum + 1}月`;
                monthItem.dataset.monthIndex = monthNum;
                monthItem.dataset.year = yearNum;

                if (monthNum === currentMonthIndex && yearNum === year) {
                    monthItem.classList.add('selected');
                }

                monthItem.addEventListener('click', () => {
                    selectedMonth = parseInt(monthItem.dataset.monthIndex);
                    renderDays(parseInt(monthItem.dataset.year), selectedMonth, 1);

                    monthList.querySelectorAll('.time-list-item').forEach(item => item.classList.remove('selected'));
                    monthItem.classList.add('selected');
                });
                monthList.appendChild(monthItem);
            }
            const selectedMonthElement = monthList.querySelector('.time-list-item.selected');
            if (selectedMonthElement) {
                selectedMonthElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function renderDays(year, monthIndex, currentDay) {
            dayList.innerHTML = '';
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const currentDayOfMonth = today.getDate();

            for (let i = 1; i <= daysInMonth; i++) {
                const dayItem = document.createElement('div');
                dayItem.classList.add('time-list-item', 'py-2', 'cursor-pointer', 'hover:bg-gray-100');
                dayItem.textContent = `${i}日`;
                dayItem.dataset.day = i;

                if (year === currentYear && monthIndex === currentMonth && i === currentDayOfMonth) {
                    dayItem.classList.add('selected');
                } else if (i === currentDay && monthIndex === selectedMonth) {
                     dayItem.classList.add('selected');
                }

                dayItem.addEventListener('click', () => {
                    selectedDay = parseInt(dayItem.dataset.day);
                    dayList.querySelectorAll('.time-list-item').forEach(item => item.classList.remove('selected'));
                    dayItem.classList.add('selected');
                });
                dayList.appendChild(dayItem);
            }
            const selectedDayElement = dayList.querySelector('.time-list-item.selected');
            if (selectedDayElement) {
                selectedDayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // =================================================
        // 数据保存与加载逻辑
        // =================================================
        const LOCAL_STORAGE_KEY_MAIN = 'publish_page_1_data';

        function savePageState() {
            const pageData = {
                loading: {
                    region: document.querySelector('.address-region-display[data-target-id="loading-region"]').textContent,
                    detail: document.querySelector('.address-detail-display[data-target-id="loading-detail"]').textContent,
                    time: {
                        selectedText: document.querySelector('.select-time-btn[data-time-type="loading"] span').textContent,
                        isAnytime: document.querySelector('.anytime-btn[data-time-type="loading"]').classList.contains('active')
                    }
                },
                unloading: {
                    region: document.querySelector('.address-region-display[data-target-id="unloading-region"]').textContent,
                    detail: document.querySelector('.address-detail-display[data-target-id="unloading-detail"]').textContent,
                    time: {
                        selectedText: document.querySelector('.select-time-btn[data-time-type="unloading"] span').textContent,
                        isAnytime: document.querySelector('.anytime-btn[data-time-type="unloading"]').classList.contains('active')
                    }
                },
                cargo: { // Save cargo data
                    display: cargoInfoDisplay.textContent,
                    isDefault: cargoInfoDisplay.classList.contains('text-gray-500'),
                    length: cargoLengthInput.value,
                    width: cargoWidthInput.value,
                    height: cargoHeightInput.value,
                    tonnage: cargoTonnageInput.value,
                    notes: cargoNotesInput.value,
                }
            };
            localStorage.setItem(LOCAL_STORAGE_KEY_MAIN, JSON.stringify(pageData));
            console.log('Page state saved:', pageData);
        }

        function loadPageState() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY_MAIN);
            if (savedData) {
                const pageData = JSON.parse(savedData);
                console.log('Page state loaded:', pageData);

                // Load Address
                ['loading', 'unloading'].forEach(type => {
                    const regionDisplay = document.querySelector(`.address-region-display[data-target-id="${type}-region"]`);
                    const detailDisplay = document.querySelector(`.address-detail-display[data-target-id="${type}-detail"]`);
                    if (pageData[type].region && pageData[type].region !== '请选择省份/城市/区县') {
                        regionDisplay.textContent = pageData[type].region;
                        regionDisplay.classList.remove('text-gray-400');
                        regionDisplay.classList.add('text-gray-800', 'font-bold');
                    }
                    if (pageData[type].detail && pageData[type].detail !== '详细地址（例如**街**号）') {
                        detailDisplay.textContent = pageData[type].detail;
                        detailDisplay.classList.remove('text-gray-400');
                        detailDisplay.classList.add('text-gray-800', 'font-semibold');
                    }
                });

                // Load Time
                ['loading', 'unloading'].forEach(type => {
                    const selectBtn = document.querySelector(`.select-time-btn[data-time-type="${type}"]`);
                    const anytimeBtn = document.querySelector(`.anytime-btn[data-time-type="${type}"]`);
                    if (pageData[type].time.isAnytime) {
                        anytimeBtn.click();
                    } else {
                        selectBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar inline-block mr-1"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>${pageData[type].time.selectedText}</span>`;
                        anytimeBtn.classList.remove('active', 'bg-blue-100', 'text-blue-600');
                        anytimeBtn.classList.add('bg-gray-100', 'text-gray-700');
                        selectBtn.classList.add('active', 'bg-blue-100', 'text-blue-600');
                        selectBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    }
                });

                // Load Cargo
                if (pageData.cargo) {
                    cargoInfoDisplay.textContent = pageData.cargo.display;
                    if(pageData.cargo.isDefault) {
                        cargoInfoDisplay.classList.add('text-gray-500');
                        cargoInfoDisplay.classList.remove('text-gray-800', 'font-semibold');
                    } else {
                        cargoInfoDisplay.classList.remove('text-gray-500');
                        cargoInfoDisplay.classList.add('text-gray-800', 'font-semibold');
                    }
                    cargoLengthInput.value = pageData.cargo.length;
                    cargoWidthInput.value = pageData.cargo.width;
                    cargoHeightInput.value = pageData.cargo.height;
                    cargoTonnageInput.value = pageData.cargo.tonnage;
                    cargoNotesInput.value = pageData.cargo.notes;
                }
            }
        }

        // =================================================
        // 按钮事件监听
        // =================================================

        temporaryLeaveBtn.addEventListener('click', () => {
            temporaryLeaveConfirmDialog.classList.remove('hidden');
        });

        confirmDevLeaveBtn.addEventListener('click', () => {
            savePageState();
            temporaryLeaveConfirmDialog.classList.add('hidden');
            window.parent.postMessage({ action: 'closePublishFlow' }, '*');
        });


        nextStepBtn.addEventListener('click', () => {
            savePageState(); // Save before going to next step
            window.parent.postMessage({ action: 'navigatePublishIframe', url: 'publish_2.html' }, '*');
        });

        // --- 初始化 ---
        updateAddressEditorButtons('');
        updateCargoEditorButtons(''); // Migrated
        showPageInIframe(mainPage);
        loadPageState(); // Load all saved data on start
        loadCargoDataFromStorage(); // Load specific cargo if returning from edit page
    });
</script>

</body>
</html>
